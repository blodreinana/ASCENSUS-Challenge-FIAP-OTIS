[{"id":"5b03057260489061","type":"function","z":"165f988cc457f842","name":"Check limites → e-mail (on change)","func":"// === CONFIG SIMPLES (ajuste) ===\nconst LIMITS = { IA_MAX: 6.5, TEMP_C_MAX: 70.0, VIB_MS2_MAX: 12.0 };\nconst TO = (flow.get('EMAIL_TO') || \"omenordograu@gmail.com\"); // troque aqui ou defina via flow.set\n// ======================================\n\n// 1) Normaliza payload (string -> objeto)\nlet p = msg.payload;\nif (typeof p === \"string\") {\n  try { p = JSON.parse(p); } catch (e) { node.warn(\"payload não é JSON\"); return null; }\n}\n\n// 2) 'data' pode vir como objeto ou string\nlet d = (p && p.data !== undefined) ? p.data : p;\nif (typeof d === \"string\") {\n  try { d = JSON.parse(d); } catch (e) {}\n}\n\n// 3) Extrai campos\nconst ia   = num(d.ia);\nconst temp = num(d.temp_c ?? d.temp ?? d.temperatura);\nconst vib  = num(d.vib_ms2 ?? d.vib_m1_ms2 ?? d.vib);\nconst origin = d.origin ?? msg.topic ?? \"mqtt\";\n\n// timestamp (se 't' vier numérico usa, senão agora)\nconst tsIso = (p && !isNaN(Number(p.t))) ? new Date(Number(p.t)).toISOString() : new Date().toISOString();\n\n// 4) Memória de estado para não spammar\nlet st = context.get('st') || { corr:false, temp:false, vib:false };\nconst out = [];\n\ncheck(\"corr\", ia,   LIMITS.IA_MAX,      \"Pico de Corrente\",    \"A\");\ncheck(\"temp\", temp, LIMITS.TEMP_C_MAX,  \"Pico de Temperatura\", \"°C\");\ncheck(\"vib\",  vib,  LIMITS.VIB_MS2_MAX, \"Pico de Vibração\",    \"m/s²\");\n\ncontext.set('st', st);\nreturn out.length ? [out] : null;\n\n// ===== helpers =====\nfunction num(v) { const x = Number(v); return Number.isFinite(x) ? x : undefined; }\n\nfunction check(key, value, limit, title, unit){\n  if (value === undefined) return;\n  const active = value > limit;             // simples (sem histerese)\n  if (active === st[key]) return;           // só em transição\n  st[key] = active;\n\n  const subject = active ? `[ALERTA] ${title}` : `[RECUPERADO] ${title}`;\n  const body = `${active ? \"⚠️\" : \"✅\"} ${title} ${active ? \"ATIVO\" : \"NORMALIZADO\"}\\n`+\n               `Valor: ${value.toFixed(2)} ${unit}\\n`+\n               `Limite: ${limit} ${unit}\\n`+\n               `Origem: ${origin}\\n`+\n               `Quando: ${tsIso}`;\n\n  out.push({ to: TO, topic: subject, payload: body });\n}\n","outputs":1,"timeout":"","noerr":0,"initialize":"","finalize":"","libs":[],"x":600,"y":640,"wires":[["5f4eb47836bbc5ca"]]}]